module Issues
  class UpdateRabattOperation < BaseOperation
    attributes :issue, :rabatt

    def call
      result = update_rabatt_issue_entry
      issue_entry = result.success
      if result.success?
        Event.broadcast(:issue_entry_updated, issue_entry_id: issue_entry.id)
        return Success(issue_entry)
      end
      Failure(result.failure)
    end

    private

    def update_rabatt_issue_entry
      yield validate_statuses
      issue_entry = update_existing_entry
      return Failure("No entry found") unless issue_entry
      return Failure(issue_entry.errors.full_messages) unless issue_entry.valid? && issue_entry.save

      Success(issue_entry)
    end

    def update_existing_entry
      entry = issue.issue_entries.category_rabatt.first
      return unless entry

      entry.update(price: rabatt)
      entry
    end

    def validate_statuses
      Success(true)
    end
  end
end
