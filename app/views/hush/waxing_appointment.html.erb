<%= render 'wellness_meta_styles' %>
<%= javascript_include_tag "booking.js", "data-turbo-track" => "reload" %>

<script>
  var bookingToken = '<%= @booking_token %>';
</script>

<div class="wellness-page">
  <%= render 'wellness_header' %>
  <%= render 'wellness_mobile_menu' %>
  <%= render 'wellness_scroll_to_top' %>

  <main>
    <div class="container">
      <!-- Appointment Booking Container -->
      <div class="appointment-booking" id="appointmentBooking">
        <!-- Step 1: Treatment Selection -->
        <div class="booking-step active" id="step1">
          <div class="booking-header">
            <h1><%= t('hush.wellness.appointment.step1_title') %></h1>
            <p class="booking-subtitle"><%= t('hush.wellness.appointment.step1_subtitle') %></p>
          </div>

          <!-- Gender Tabs -->
          <div class="booking-tabs">
            <button class="booking-tab active" data-gender="women" onclick="switchBookingTab('women')">
              <%= t('hush.wellness.pricing.women') %>
            </button>
            <button class="booking-tab" data-gender="men" onclick="switchBookingTab('men')">
              <%= t('hush.wellness.pricing.men') %>
            </button>
          </div>

          <!-- Women's Treatments List -->
          <%= render 'treatments_list', articles: @women_articles, mode: :appointment, gender: :women %>

          <!-- Men's Treatments List -->
          <%= render 'treatments_list', articles: @men_articles, mode: :appointment, gender: :men, container_id: 'treatments-container-men', list_id: 'treatmentsListMen', container_style: 'display: none;' %>

          <div class="booking-summary" id="bookingSummary" style="display: none;">
            <div class="summary-content">
              <h3>
                <%= t('hush.wellness.appointment.selected_treatments') %>
                <span class="gender-indicator" id="genderIndicator"></span>
              </h3>
              <div id="selectedTreatmentsList"></div>
              <div class="summary-total">
                <strong><%= t('hush.wellness.appointment.total_price') %>: <span id="totalPrice">€0</span></strong>
              </div>
            </div>
            <button class="cta-button continue-button" id="continueButton" onclick="goToStep2()">
              <%= t('hush.wellness.appointment.continue_button') %>
            </button>
          </div>
        </div>

        <!-- Step 2: Date & Time Selection -->
        <div class="booking-step" id="step2">
          <div class="booking-header">
            <h1><%= t('hush.wellness.appointment.step2_title') %></h1>
            <p class="booking-subtitle"><%= t('hush.wellness.appointment.step2_subtitle') %></p>
          </div>

          <div class="date-time-selection">
            <div class="date-selection-section">
              <h3><%= t('hush.wellness.appointment.select_date') %></h3>
              <div class="calendar-container">
                <div class="calendar-header">
                  <button class="calendar-nav" onclick="changeMonth(-1)" id="prevMonth">‹</button>
                  <h4 id="currentMonthYear"></h4>
                  <button class="calendar-nav" onclick="changeMonth(1)" id="nextMonth">›</button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                  <!-- Calendar days will be generated by JavaScript -->
                </div>
              </div>
            </div>

            <div class="time-selection-section">
              <h3><%= t('hush.wellness.appointment.select_time') %></h3>
              <div class="time-slots-grid" id="timeSlotsGrid">
                <!-- Time slots will be generated by JavaScript -->
              </div>
            </div>
          </div>

          <div class="booking-actions">
            <button class="cta-button back-button" onclick="goToStep1()">
              <%= t('hush.wellness.appointment.back_button') %>
            </button>
            <button class="cta-button confirm-button" id="confirmButton" onclick="goToStep3()" style="display: none;">
              <%= t('hush.wellness.appointment.continue_button') %>
            </button>
          </div>
        </div>

        <!-- Step 3: Customer Information -->
        <div class="booking-step" id="step3">
          <div class="booking-header">
            <h1><%= t('hush.wellness.appointment.step3_title') %></h1>
            <p class="booking-subtitle"><%= t('hush.wellness.appointment.step3_subtitle') %></p>
          </div>

          <div class="customer-form">
            <form id="customerInfoForm" onsubmit="submitBooking(event); return false;">
              <div class="form-group">
                <label for="fullName"><%= t('hush.wellness.appointment.full_name') %> *</label>
                <input type="text" id="fullName" name="fullName" required>
                <div class="error-message" id="fullNameError"></div>
              </div>

              <div class="form-group">
                <label for="phoneNumber"><%= t('hush.wellness.appointment.phone_number') %> *</label>
                <input type="tel" id="phoneNumber" name="phoneNumber" required>
                <div class="error-message" id="phoneNumberError"></div>
              </div>

              <div class="form-group">
                <label for="email"><%= t('hush.wellness.appointment.email') %></label>
                <input type="email" id="email" name="email">
                <div class="error-message" id="emailError"></div>
              </div>

              <div class="form-group checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="consentCheckbox" name="consent" required>
                  <span><%= t('hush.wellness.appointment.consent_checkbox') %> <a href="<%= datenschutz_path(locale: I18n.locale) %>" target="_blank"><%= t('hush.wellness.footer.privacy') %></a></span>
                </label>
                <div class="error-message" id="consentError"></div>
              </div>

              <div class="submit-errors" id="submitErrors"></div>

              <div class="booking-actions">
                <button type="button" class="cta-button back-button" onclick="goBackToStep2()">
                  <%= t('hush.wellness.appointment.back_button') %>
                </button>
                <button type="submit" class="cta-button submit-button" id="submitButton">
                  <%= t('hush.wellness.appointment.submit_appointment') %>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%= render 'wellness_footer' %>
</div>

<style>
  /* Hide second header and booking button on appointment page */
  .wellness-header .header-bottom {
    display: none !important;
  }

  .wellness-header .header-top .cta-button {
    display: none !important;
  }

  /* Appointment Booking Styles */
  .appointment-booking {
    max-width: 1200px;
    margin: 140px auto 8rem;
    padding: 4rem 2rem;
  }

  .booking-header {
    text-align: center;
    margin-bottom: 4rem;
  }

  .booking-header h1 {
    font-size: clamp(2.5rem, 5vw, 4rem);
    font-weight: 300;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 1rem;
  }

  .booking-subtitle {
    font-size: 1.1rem;
    font-weight: 300;
    color: var(--gray);
    margin-top: 1rem;
  }

  .booking-step {
    display: none;
  }

  .booking-step.active {
    display: block;
  }

  /* Booking Tabs */
  .booking-tabs {
    display: flex;
    justify-content: center;
    gap: 0;
    margin-bottom: 2rem;
    border-bottom: 1px solid var(--black);
  }

  .booking-tab {
    padding: 1rem 3rem;
    background: var(--white);
    border: 1px solid var(--black);
    border-bottom: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--gray);
    transition: all 0.3s ease;
    position: relative;
    top: 1px;
  }

  .booking-tab:first-child {
    border-right: none;
  }

  .booking-tab:hover {
    background: var(--gray-light);
  }

  .booking-tab.active {
    background: var(--black);
    color: var(--white);
    font-weight: 400;
  }

  .booking-tab.active:hover {
    background: var(--black);
    color: var(--white);
  }

  /* Treatment List */
  .treatments-list-container {
    border: 1px solid var(--black);
    margin-bottom: 4rem;
  }

  .treatments-list {
    display: flex;
    flex-direction: column;
  }

  .treatment-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--black);
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: var(--white);
    position: relative;
    z-index: 2;
  }

  .treatment-row:last-child {
    border-bottom: none;
  }

  .treatment-row:hover {
    background: var(--black);
    color: var(--white);
  }

  .treatment-row:hover .treatment-name,
  .treatment-row:hover .treatment-price {
    color: var(--white);
  }

  .treatment-row.selected {
    background: var(--black);
    color: var(--white);
  }

  .treatment-row.selected .treatment-name,
  .treatment-row.selected .treatment-price {
    color: var(--white);
  }

  .treatment-row-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex: 1;
    padding-right: 2rem;
  }

  .treatment-name {
    font-size: 1rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--black);
  }

  .treatment-price {
    font-size: 15px;
    font-weight: 400;
    color: var(--black);
  }

  .treatment-row.package-row .treatment-price {
    font-weight: 500;
    font-size: 16px;
  }

  .treatment-checkbox {
    flex-shrink: 0;
  }

  .treatment-checkbox input[type="checkbox"] {
    display: none;
  }

  .treatment-checkbox label {
    width: 24px;
    height: 24px;
    border: 2px solid var(--black);
    display: block;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
    background: var(--white);
  }

  .treatment-row.selected .treatment-checkbox label {
    background: var(--white);
    border-color: var(--white);
  }

  .treatment-row.selected .treatment-checkbox label::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--black);
    font-size: 14px;
    font-weight: 600;
  }

  .treatment-row.package-row {
    background-color: var(--gray-light);
    font-weight: 400;
    position: relative;
    z-index: 2;
  }

  .treatment-row.package-row:hover {
    background: var(--black);
    color: var(--white);
  }

  .treatment-row.package-row:hover .treatment-name,
  .treatment-row.package-row:hover .treatment-price {
    color: var(--white);
  }

  .treatment-row.package-row.selected {
    background: var(--black);
    color: var(--white);
  }

  .treatment-row.package-row.selected .treatment-name,
  .treatment-row.package-row.selected .treatment-price {
    color: var(--white);
  }

  .treatment-row.package-row:hover .treatment-checkbox label {
    border-color: var(--white);
  }

  .treatment-row.package-header-row {
    background: var(--black);
    color: var(--white);
    cursor: default;
    pointer-events: none;
  }

  .treatment-row.package-header-row .treatment-name {
    color: var(--white);
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .treatment-row.package-header-row:hover {
    background: var(--black);
  }

  /* Booking Summary */
  .booking-summary {
    border-top: 1px solid var(--black);
    padding-top: 3rem;
    margin-top: 3rem;
  }

  .summary-content h3 {
    font-size: 1.1rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .gender-indicator {
    font-size: 0.9rem;
    font-weight: 400;
    text-transform: none;
    color: var(--black);
    font-style: normal;
    opacity: 0.7;
    display: inline-block;
    margin-left: 0.5rem;
  }

  #selectedTreatmentsList {
    margin-bottom: 2rem;
  }

  .selected-treatment-item {
    display: flex;
    justify-content: space-between;
    padding: 1rem 0;
    border-bottom: 1px solid var(--gray-light);
    font-size: 0.95rem;
  }

  .summary-total {
    font-size: 1.25rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--black);
    margin-top: 1.5rem;
  }

  .continue-button {
    width: 100%;
    margin-top: 2rem;
    text-align: center;
  }

  /* Date & Time Selection */
  .date-time-selection {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4rem;
    margin-bottom: 4rem;
    width: 100%;
  }

  .date-selection-section,
  .time-selection-section {
    width: 100%;
    min-width: 0;
  }

  .date-selection-section h3,
  .time-selection-section h3 {
    font-size: 1.1rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 2rem;
  }

  /* Calendar */
  .calendar-container {
    border: 1px solid var(--black);
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }

  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--black);
    background: var(--black);
    color: var(--white);
  }

  .calendar-header h4 {
    font-size: 1rem;
    font-weight: 300;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--white);
  }

  .calendar-nav {
    background: transparent;
    border: 1px solid var(--white);
    color: var(--white);
    width: 40px;
    height: 40px;
    cursor: pointer;
    font-size: 1.5rem;
    transition: all 0.3s ease;
  }

  .calendar-nav:hover {
    background: var(--white);
    color: var(--black);
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0;
  }

  .calendar-day-header {
    padding: 1rem;
    text-align: center;
    font-size: 0.75rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    border-bottom: 1px solid var(--black);
    border-right: 1px solid var(--black);
    background: var(--gray-light);
  }

  .calendar-day-header:last-child {
    border-right: none;
  }

  .calendar-day {
    padding: 1.5rem;
    text-align: center;
    border-bottom: 1px solid var(--black);
    border-right: 1px solid var(--black);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.95rem;
    position: relative;
  }

  .calendar-day:last-child {
    border-right: none;
  }

  .calendar-day.other-month {
    color: var(--gray);
    background: var(--gray-light);
  }

  .calendar-day.today {
    background: var(--gray-light);
    font-weight: 600;
  }

  .calendar-day.selected {
    background: var(--black);
    color: var(--white);
  }

  .calendar-day.disabled {
    color: var(--gray);
    cursor: not-allowed;
    opacity: 0.4;
  }

  .calendar-day:not(.disabled):not(.other-month):hover {
    background: var(--black);
    color: var(--white);
  }

  .calendar-day.selected:hover {
    background: var(--black);
    color: var(--white);
  }

  /* Time Slots */
  .time-slots-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
  }

  .time-slot {
    padding: 1.25rem 1rem;
    border: 1px solid var(--black);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.95rem;
    font-weight: 300;
    background: var(--white);
  }

  .time-slot:hover:not(.disabled):not(.selected) {
    background: var(--black);
    color: var(--white);
    border-color: var(--black);
  }

  .time-slot.selected {
    background: var(--black);
    color: var(--white);
    border-color: var(--black);
  }

  .time-slot.disabled {
    color: var(--gray);
    cursor: not-allowed;
    opacity: 0.4;
    border-color: var(--gray);
  }

  /* Booking Actions */
  .booking-actions {
    display: flex;
    justify-content: space-between;
    gap: 2rem;
    margin-top: 3rem;
    padding-top: 3rem;
    border-top: 1px solid var(--black);
  }

  .back-button,
  .confirm-button {
    flex: 1;
    min-width: 0;
  }

  .back-button {
    background: var(--white);
    color: var(--black);
  }

  .back-button:hover {
    background: var(--black);
    color: var(--white);
  }

  .confirm-button {
    background: var(--black);
    color: var(--white);
  }

  .confirm-button:hover {
    background: var(--gray);
    color: var(--white);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .date-time-selection {
      grid-template-columns: 1fr;
      gap: 3rem;
    }

  }

  @media (max-width: 768px) {
    .appointment-booking {
      margin-top: 120px;
      padding: 2rem 1rem;
    }

    .treatment-row {
      padding: 1.25rem 1.5rem;
    }

    .treatment-row-content {
      padding-right: 1rem;
    }

    .treatment-name {
      font-size: 0.9rem;
    }

    .treatment-price {
      font-size: 0.9rem;
    }

    .date-time-selection {
      gap: 2rem;
    }

    .date-selection-section,
    .time-selection-section {
      width: 100%;
      max-width: 100%;
    }

    .calendar-container {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    .calendar-header {
      padding: 1rem 1.5rem;
    }

    .calendar-header h4 {
      font-size: 0.85rem;
    }

    .calendar-nav {
      width: 35px;
      height: 35px;
      font-size: 1.2rem;
    }

    .calendar-day-header {
      padding: 0.75rem 0.5rem;
      font-size: 0.65rem;
    }

    .calendar-day {
      padding: 1rem 0.5rem;
      font-size: 0.85rem;
    }

    .time-slots-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    .time-slot {
      padding: 1rem 0.75rem;
      font-size: 0.85rem;
    }

    .booking-actions {
      flex-direction: column;
      gap: 1rem;
    }

    .back-button,
    .confirm-button {
      width: 100%;
      flex: none;
    }
  }

  /* Customer Form Styles */
  .customer-form {
    max-width: 600px;
    margin: 0 auto;
  }

  .form-group {
    margin-bottom: 2rem;
  }

  .form-group label {
    display: block;
    font-size: 1rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.75rem;
    color: var(--black);
  }

  .form-group input[type="text"],
  .form-group input[type="tel"],
  .form-group input[type="email"] {
    width: 100%;
    padding: 1rem;
    border: 1px solid var(--black);
    font-size: 1rem;
    font-family: inherit;
    background: var(--white);
    color: var(--black);
    transition: border-color 0.3s ease;
    box-sizing: border-box;
  }

  .form-group input[type="text"]:focus,
  .form-group input[type="tel"]:focus,
  .form-group input[type="email"]:focus {
    outline: none;
    border-color: #000;
    border-width: 2px;
    background: var(--white);
    color: var(--black);
  }

  .form-group input.field-error {
    border-color: #dc3545;
    border-width: 2px;
  }

  .error-message {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    display: none;
  }

  .error-message.show {
    display: block;
  }

  .checkbox-group {
    margin-top: 2rem;
  }

  .checkbox-label {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    font-weight: 300;
    text-transform: none;
    letter-spacing: normal;
  }

  .checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 0.75rem;
    margin-top: 2px;
    flex-shrink: 0;
    cursor: pointer;
    accent-color: var(--black);
    background-color: var(--white);
    border: 1px solid var(--black);
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    position: relative;
  }

  .checkbox-label input[type="checkbox"]:checked {
    background-color: var(--black);
    border-color: var(--black);
  }

  .checkbox-label input[type="checkbox"]:checked::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--white);
    font-size: 14px;
    font-weight: 600;
  }

  .checkbox-label span {
    line-height: 1.5;
  }

  .checkbox-label a {
    color: var(--black);
    text-decoration: underline;
  }

  .checkbox-label a:hover {
    color: var(--gray);
  }

  .submit-errors {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    display: none;
  }

  .submit-errors.show {
    display: block;
  }

  .submit-errors .error-item {
    color: #dc3545;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }

  .submit-errors .error-item:last-child {
    margin-bottom: 0;
  }

  .submit-button {
    background: var(--black);
    color: var(--white);
  }

  .submit-button:hover {
    background: var(--gray);
    color: var(--white);
  }

  .submit-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>

<script>
  // Treatment selection data - Women
  const treatmentsWomen = {
    upper_lip: { name: '<%= t('hush.wellness.appointment.treatments.upper_lip') %>', min: 12, max: 15 },
    full_face: { name: '<%= t('hush.wellness.appointment.treatments.full_face') %>', min: 30, max: 40 },
    underarms: { name: '<%= t('hush.wellness.appointment.treatments.underarms') %>', min: 12, max: 15 },
    forearms: { name: '<%= t('hush.wellness.appointment.treatments.forearms') %>', min: 25, max: 30 },
    full_arms: { name: '<%= t('hush.wellness.appointment.treatments.full_arms') %>', min: 40, max: 45 },
    lower_legs: { name: '<%= t('hush.wellness.appointment.treatments.lower_legs') %>', min: 30, max: 35 },
    upper_legs: { name: '<%= t('hush.wellness.appointment.treatments.upper_legs') %>', min: 30, max: 35 },
    full_legs: { name: '<%= t('hush.wellness.appointment.treatments.full_legs') %>', min: 55, max: 65 },
    classic_bikini: { name: '<%= t('hush.wellness.appointment.treatments.classic_bikini') %>', min: 22, max: 25 },
    deep_bikini: { name: '<%= t('hush.wellness.appointment.treatments.deep_bikini') %>', min: 45, max: 55 },
    stomach: { name: '<%= t('hush.wellness.appointment.treatments.stomach') %>', min: 16, max: 20 },
    lower_back: { name: '<%= t('hush.wellness.appointment.treatments.lower_back') %>', min: 20, max: 20 },
    buttocks: { name: '<%= t('hush.wellness.appointment.treatments.buttocks') %>', min: 18, max: 20 },
    package_1: { name: '<%= t('hush.wellness.appointment.treatments.package_1') %>', min: 65, max: 65 },
    package_2: { name: '<%= t('hush.wellness.appointment.treatments.package_2') %>', min: 95, max: 95 },
    package_3: { name: '<%= t('hush.wellness.appointment.treatments.package_3') %>', min: 120, max: 120 },
    package_4: { name: '<%= t('hush.wellness.appointment.treatments.package_4') %>', min: 130, max: 130 }
  };

  // Treatment selection data - Men
  const treatmentsMen = {
    men_nose: { name: '<%= t('hush.wellness.men_treatments.nose') %>', min: 15, max: 15 },
    men_ears: { name: '<%= t('hush.wellness.men_treatments.ears') %>', min: 15, max: 15 },
    men_eyebrows: { name: '<%= t('hush.wellness.men_treatments.eyebrows') %>', min: 20, max: 20 },
    men_face: { name: '<%= t('hush.wellness.men_treatments.face') %>', min: 40, max: 40 },
    men_arms_to_elbow: { name: '<%= t('hush.wellness.men_treatments.arms_to_elbow') %>', min: 35, max: 35 },
    men_full_arms: { name: '<%= t('hush.wellness.men_treatments.full_arms') %>', min: 50, max: 50 },
    men_legs_to_knees: { name: '<%= t('hush.wellness.men_treatments.legs_to_knees') %>', min: 45, max: 45 },
    men_legs_above_knees: { name: '<%= t('hush.wellness.men_treatments.legs_above_knees') %>', min: 55, max: 55 },
    men_full_legs: { name: '<%= t('hush.wellness.men_treatments.full_legs') %>', min: 70, max: 70 },
    men_back: { name: '<%= t('hush.wellness.men_treatments.back') %>', min: 50, max: 50 },
    men_upper_body: { name: '<%= t('hush.wellness.men_treatments.upper_body') %>', min: 60, max: 60 },
    men_package_1: { name: '<%= t('hush.wellness.men_packages.back_upper_body') %>', min: 100, max: 100 },
    men_package_2: { name: '<%= t('hush.wellness.men_packages.arms_legs_full') %>', min: 120, max: 120 },
    men_package_3: { name: '<%= t('hush.wellness.men_packages.complete') %>', min: 170, max: 170 }
  };

  // Current gender selection (default: women)
  let currentGender = 'women';
  let treatments = treatmentsWomen;

  let selectedTreatments = [];
  let selectedDate = null;
  let selectedTime = null;
  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    initializeTreatmentSelection();
    initializeCalendar();
    initializeTimeSlots();
    initializeFormValidation();
  });

  // Check if element is visible in viewport
  function isElementVisible(element) {
    if (!element || element.offsetParent === null) {
      return false;
    }

    const rect = element.getBoundingClientRect();
    const windowHeight = window.innerHeight || document.documentElement.clientHeight;
    const windowWidth = window.innerWidth || document.documentElement.clientWidth;

    // Check if element is within viewport bounds
    return (
      rect.top >= 0 &&
      rect.left >= 0 &&
      rect.bottom <= windowHeight &&
      rect.right <= windowWidth
    );
  }

  // Check if element is partially visible (at least 50% visible)
  function isElementPartiallyVisible(element) {
    if (!element || element.offsetParent === null) {
      return false;
    }

    const rect = element.getBoundingClientRect();
    const windowHeight = window.innerHeight || document.documentElement.clientHeight;
    const windowWidth = window.innerWidth || document.documentElement.clientWidth;

    // Check if at least 50% of element is visible
    const visibleHeight = Math.min(rect.bottom, windowHeight) - Math.max(rect.top, 0);
    const visibleWidth = Math.min(rect.right, windowWidth) - Math.max(rect.left, 0);
    const elementHeight = rect.height;
    const elementWidth = rect.width;

    return (visibleHeight / elementHeight >= 0.5) && (visibleWidth / elementWidth >= 0.5);
  }

  // Switch between Women and Men tabs
  function switchBookingTab(gender) {
    currentGender = gender;

    // Hide both containers
    document.getElementById('treatments-container-women').style.display = 'none';
    document.getElementById('treatments-container-men').style.display = 'none';

    // Remove active class from all tabs
    document.querySelectorAll('.booking-tab').forEach(tab => {
      tab.classList.remove('active');
    });

    // Show selected container and activate corresponding tab
    if (gender === 'women') {
      document.getElementById('treatments-container-women').style.display = 'block';
      document.querySelector('.booking-tab[data-gender="women"]').classList.add('active');
    } else {
      document.getElementById('treatments-container-men').style.display = 'block';
      document.querySelector('.booking-tab[data-gender="men"]').classList.add('active');
    }

    // Clear selected treatments when switching
    selectedTreatments = [];
    document.querySelectorAll('.treatment-row').forEach(row => {
      row.classList.remove('selected');
      const checkbox = row.querySelector('input[type="checkbox"]');
      if (checkbox) {
        checkbox.checked = false;
      }
    });
    updateSummary();

    // Reinitialize treatment selection for the new container
    initializeTreatmentSelection();
  }

  // Treatment Selection
  function initializeTreatmentSelection() {
    // Remove existing event listeners by cloning and replacing
    const womenContainer = document.getElementById('treatments-container-women');
    const menContainer = document.getElementById('treatments-container-men');

    [womenContainer, menContainer].forEach(container => {
      if (!container) return;

      const rows = container.querySelectorAll('.treatment-row');
      rows.forEach(row => {
        // Skip package header row
        if (row.classList.contains('package-header-row')) {
          return;
        }

        // Remove existing listeners by cloning
        const newRow = row.cloneNode(true);
        row.parentNode.replaceChild(newRow, row);

        const checkbox = newRow.querySelector('input[type="checkbox"]');
        if (!checkbox) {
          return;
        }

        // Handle row click
        newRow.addEventListener('click', function(e) {
          // Don't toggle if clicking directly on checkbox
          if (e.target === checkbox) {
            return;
          }

          // If clicking on the label, let the label's default behavior handle it
          if (e.target.tagName === 'LABEL' || e.target.closest('.treatment-checkbox')) {
            // The label's default behavior will toggle the checkbox
            // We'll handle the UI update via the change event
            return;
          }

          // For all other clicks on the row, toggle the checkbox
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        });

        // Handle checkbox change event
        checkbox.addEventListener('change', function() {
          toggleTreatment(newRow, this.checked);
        });
      });
    });
  }

  function toggleTreatment(row, isSelected) {
    if (isSelected) {
      row.classList.add('selected');
      const sku = row.dataset.sku;
      if (sku && !selectedTreatments.includes(sku)) {
        selectedTreatments.push(sku);
      }
    } else {
      row.classList.remove('selected');
      const sku = row.dataset.sku;
      if (sku) {
        selectedTreatments = selectedTreatments.filter(t => t !== sku);
      }
    }
    updateSummary();

    // Scroll to continue button when treatment is selected
    if (isSelected && selectedTreatments.length === 1) {
      setTimeout(() => {
        const continueButton = document.getElementById('continueButton');
        if (continueButton && continueButton.offsetParent !== null && !isElementPartiallyVisible(continueButton)) {
          continueButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }, 300);
    }
  }

  function updateSummary() {
    const summary = document.getElementById('bookingSummary');
    const list = document.getElementById('selectedTreatmentsList');
    const totalPriceEl = document.getElementById('totalPrice');
    const continueBtn = document.getElementById('continueButton');
    const genderIndicator = document.getElementById('genderIndicator');

    if (selectedTreatments.length === 0) {
      summary.style.display = 'none';
      if (genderIndicator) {
        genderIndicator.textContent = '';
      }
      return;
    }

    summary.style.display = 'block';
    list.innerHTML = '';

    // Update gender indicator
    if (genderIndicator) {
      const genderText = currentGender === 'women' ? '<%= t('hush.wellness.pricing.women') %>' : '<%= t('hush.wellness.pricing.men') %>';
      genderIndicator.textContent = `(${genderText})`;
    }

    let totalMin = 0;
    let totalMax = 0;

    selectedTreatments.forEach(sku => {
      // Find the row with this SKU
      const row = document.querySelector(`.treatment-row[data-sku="${sku}"]`);
      if (row) {
        const nameElement = row.querySelector('.treatment-name');
        const priceMin = parseFloat(row.dataset.priceMin) || 0;
        const priceMax = parseFloat(row.dataset.priceMax) || 0;
        const name = nameElement ? nameElement.textContent.trim() : '';

        totalMin += priceMin;
        totalMax += priceMax;

        const item = document.createElement('div');
        item.className = 'selected-treatment-item';
        const priceText = priceMin === priceMax ? `€${priceMin.toFixed(2)}` : `€${priceMin.toFixed(2)} - €${priceMax.toFixed(2)}`;
        item.innerHTML = `
          <span>${name}</span>
          <span>${priceText}</span>
        `;
        list.appendChild(item);
      }
    });

    if (totalMin === totalMax) {
      totalPriceEl.textContent = `€${totalMin.toFixed(2)}`;
    } else {
      totalPriceEl.textContent = `€${totalMin.toFixed(2)} - €${totalMax.toFixed(2)}`;
    }
  }

  async function goToStep2() {
    if (selectedTreatments.length === 0) {
      alert('<%= t('hush.wellness.appointment.no_treatment_selected') %>');
      return;
    }

    // Fetch available dates before showing calendar
    if (window.bookingAPI) {
      await window.bookingAPI.initializeAvailableDates();
      // Re-render calendar after dates are loaded to show disabled dates
      renderCalendar();
    }

    // Hide step 1 and show step 2
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    if (step1) {
      step1.classList.remove('active');
      step1.style.display = 'none'; // Explicitly hide
    }
    if (step2) {
      step2.classList.add('active');
      step2.style.display = 'block'; // Explicitly show
    }
    updateTimeSlots();

    // Scroll to top first to ensure step1 is out of view
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Then scroll to date container when moving to step 2
    setTimeout(() => {
      const dateSection = document.querySelector('.date-selection-section');
      if (dateSection && !isElementPartiallyVisible(dateSection)) {
        dateSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Add small offset for better visibility
        setTimeout(() => {
          window.scrollBy({ top: -20, behavior: 'smooth' });
        }, 500);
      }
    }, 100);
  }

  function goToStep1() {
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    if (step2) {
      step2.classList.remove('active');
      step2.style.display = 'none'; // Explicitly hide
    }
    if (step1) {
      step1.classList.add('active');
      step1.style.display = 'block'; // Explicitly show
    }
    selectedDate = null;
    selectedTime = null;
    updateTimeSlots();
    updateConfirmButton();

    // Scroll to top when going back
    setTimeout(() => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
  }

  function goBackToStep2() {
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    if (step3) {
      step3.classList.remove('active');
      step3.style.display = 'none'; // Explicitly hide
    }
    if (step2) {
      step2.classList.add('active');
      step2.style.display = 'block'; // Explicitly show
    }

    // Scroll to top of step 2
    setTimeout(() => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
  }

  function goToStep3() {
    if (!selectedDate || !selectedTime || selectedTreatments.length === 0) {
      alert('<%= t('hush.wellness.appointment.please_select_date_time') %>');
      return;
    }

    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    if (step2) {
      step2.classList.remove('active');
      step2.style.display = 'none'; // Explicitly hide
    }
    if (step3) {
      step3.classList.add('active');
      step3.style.display = 'block'; // Explicitly show
    }

    // Scroll to top of step 3
    setTimeout(() => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
  }

  // Calendar
  function initializeCalendar() {
    renderCalendar();
  }

  function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    const monthYear = document.getElementById('currentMonthYear');

    const date = new Date(currentYear, currentMonth, 1);
    const monthNames = [
      '<%= t('hush.wellness.calendar.months.january') %>',
      '<%= t('hush.wellness.calendar.months.february') %>',
      '<%= t('hush.wellness.calendar.months.march') %>',
      '<%= t('hush.wellness.calendar.months.april') %>',
      '<%= t('hush.wellness.calendar.months.may') %>',
      '<%= t('hush.wellness.calendar.months.june') %>',
      '<%= t('hush.wellness.calendar.months.july') %>',
      '<%= t('hush.wellness.calendar.months.august') %>',
      '<%= t('hush.wellness.calendar.months.september') %>',
      '<%= t('hush.wellness.calendar.months.october') %>',
      '<%= t('hush.wellness.calendar.months.november') %>',
      '<%= t('hush.wellness.calendar.months.december') %>'
    ];

    monthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;

    // JavaScript getDay() returns: 0=Sunday, 1=Monday, 2=Tuesday, etc.
    // But our calendar starts with Monday, so we need to adjust:
    // Sunday (0) -> 6, Monday (1) -> 0, Tuesday (2) -> 1, etc.
    const firstDayOfWeek = date.getDay(); // 0-6 (Sunday-Saturday)
    const firstDay = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1; // Convert to Monday-based (0-6, Monday-Sunday)

    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const today = new Date();
    const currentDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    grid.innerHTML = '';

    // Day headers (Monday first)
    const dayHeaders = ['<%= t('hush.wellness.calendar.days.monday') %>', '<%= t('hush.wellness.calendar.days.tuesday') %>', '<%= t('hush.wellness.calendar.days.wednesday') %>', '<%= t('hush.wellness.calendar.days.thursday') %>', '<%= t('hush.wellness.calendar.days.friday') %>', '<%= t('hush.wellness.calendar.days.saturday') %>', '<%= t('hush.wellness.calendar.days.sunday') %>'];
    dayHeaders.forEach(day => {
      const header = document.createElement('div');
      header.className = 'calendar-day-header';
      header.textContent = day;
      grid.appendChild(header);
    });

    // Previous month days
    const prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
    for (let i = firstDay - 1; i >= 0; i--) {
      const day = document.createElement('div');
      day.className = 'calendar-day other-month';
      day.textContent = prevMonthDays - i;
      grid.appendChild(day);
    }

    // Current month days
    for (let i = 1; i <= daysInMonth; i++) {
      const day = document.createElement('div');
      day.className = 'calendar-day';
      day.textContent = i;

      const dayDate = new Date(currentYear, currentMonth, i);

      // Check if date is in the past
      if (dayDate < currentDate) {
        day.classList.add('disabled');
      } else {
        // Check if date is available (using booking API)
        if (window.bookingAPI && !window.bookingAPI.isDateAvailable(dayDate)) {
          day.classList.add('disabled');
        } else {
          // Check if today
          if (dayDate.getTime() === currentDate.getTime()) {
            day.classList.add('today');
          }

          // Check if selected
          if (selectedDate && dayDate.getTime() === selectedDate.getTime()) {
            day.classList.add('selected');
          }
        }
      }

      day.addEventListener('click', async function() {
        if (!this.classList.contains('disabled')) {
          // Check if this is a different day than currently selected
          const clickedDate = new Date(currentYear, currentMonth, i);
          const isNewDay = !selectedDate || clickedDate.getTime() !== selectedDate.getTime();

          document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
          this.classList.add('selected');
          selectedDate = clickedDate;

          // Reset time selection when a new day is selected
          if (isNewDay) {
            selectedTime = null;
          }

          // Fetch time slots for selected date
          if (window.bookingAPI) {
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            await fetchTimeSlotsForDate(dateStr);
          }

          updateTimeSlots();
          updateConfirmButton();

          // Scroll to time selection when date is selected
          setTimeout(() => {
            const timeSection = document.querySelector('.time-selection-section');
            if (timeSection && !isElementPartiallyVisible(timeSection)) {
              timeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              // Add small offset for better visibility
              setTimeout(() => {
                window.scrollBy({ top: -20, behavior: 'smooth' });
              }, 500);
            }
          }, 300);
        }
      });

      grid.appendChild(day);
    }

    // Next month days
    const totalCells = grid.children.length;
    const remainingCells = 42 - totalCells; // 6 rows * 7 days
    for (let i = 1; i <= remainingCells && i <= 14; i++) {
      const day = document.createElement('div');
      day.className = 'calendar-day other-month';
      day.textContent = i;
      grid.appendChild(day);
    }
  }

  async function changeMonth(direction) {
    // Reset selected time and date when month changes
    selectedTime = null;
    selectedDate = null;

    // Clear time slots and hide confirm button
    updateTimeSlots();
    updateConfirmButton();

    currentMonth += direction;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    } else if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }

    // Fetch available dates for the new month
    if (window.bookingAPI) {
      await window.bookingAPI.fetchAvailableDatesForMonth(currentMonth, currentYear);
    } else {
      renderCalendar();
    }
  }

  // Time Slots
  function initializeTimeSlots() {
    updateTimeSlots();
  }

  // Fetch time slots for a specific date
  async function fetchTimeSlotsForDate(dateStr) {
    if (!window.bookingAPI) {
      return;
    }

    try {
      const url = `${window.location.origin || 'http://localhost:3001'}/api/partner/calendar_entries/available_slots?start_date=${dateStr}&end_date=${dateStr}&merchant_id=2`;

      const token = window.bookingToken ;
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': 'Token token=' + token,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const data = await response.json();
        // Store available time slots for the selected date
        window.availableTimeSlots = Array.isArray(data) ? data : [];
      }
    } catch (error) {
      console.error('Error fetching time slots:', error);
      window.availableTimeSlots = [];
    }
  }

  function updateTimeSlots() {
    const grid = document.getElementById('timeSlotsGrid');
    grid.innerHTML = '';

    if (!selectedDate) {
      return;
    }

    // Generate time slots from 09:00 to 19:00 in 30-minute intervals
    const slots = [];
    for (let hour = 9; hour < 19; hour++) {
      slots.push(`${hour.toString().padStart(2, '0')}:00`);
      slots.push(`${hour.toString().padStart(2, '0')}:30`);
    }

    slots.forEach(slot => {
      const timeSlot = document.createElement('div');
      timeSlot.className = 'time-slot';
      timeSlot.textContent = slot;

      // Format date for time slot check
      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      const dateStr = formatDate(selectedDate);
      const timeSlotStr = `${dateStr} ${slot}:00`;

      // Check if time slot is available from API
      let isAvailable = true;
      if (window.availableTimeSlots && Array.isArray(window.availableTimeSlots) && window.availableTimeSlots.length > 0) {
        // API returns objects with { start: "2026-01-30T10:00:00.000+01:00", end: "..." }
        // Extract time from start property and compare with slot time
        isAvailable = window.availableTimeSlots.some(availableSlot => {
          if (!availableSlot || typeof availableSlot !== 'object' || !availableSlot.start) {
            return false;
          }

          // Extract time from ISO datetime string (e.g., "2026-01-30T10:00:00.000+01:00" -> "10:00")
          const startTime = new Date(availableSlot.start);
          const slotHours = startTime.getHours().toString().padStart(2, '0');
          const slotMinutes = startTime.getMinutes().toString().padStart(2, '0');
          const availableTimeStr = `${slotHours}:${slotMinutes}`;

          // Compare with current slot (e.g., "10:00")
          return availableTimeStr === slot;
        });
      }

      // Check if time slot is in the past (for today)
      const today = new Date();
      if (selectedDate.getDate() === today.getDate() &&
          selectedDate.getMonth() === today.getMonth() &&
          selectedDate.getFullYear() === today.getFullYear()) {
        const [hours, minutes] = slot.split(':');
        const slotTime = new Date();
        slotTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
        if (slotTime < today) {
          isAvailable = false;
        }
      }

      if (!isAvailable) {
        timeSlot.classList.add('disabled');
      }

      if (selectedTime === slot) {
        timeSlot.classList.add('selected');
      }

      timeSlot.addEventListener('click', function() {
        if (!this.classList.contains('disabled')) {
          document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
          this.classList.add('selected');
          selectedTime = slot;
          updateConfirmButton();

          // Scroll to confirm button when time is selected
          setTimeout(() => {
            const confirmButton = document.getElementById('confirmButton');
            if (confirmButton && confirmButton.style.display !== 'none' && !isElementPartiallyVisible(confirmButton)) {
              confirmButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              // Add small offset for better visibility
              setTimeout(() => {
                window.scrollBy({ top: 20, behavior: 'smooth' });
              }, 500);
            }
          }, 300);
        }
      });

      grid.appendChild(timeSlot);
    });
  }

  function updateConfirmButton() {
    const confirmBtn = document.getElementById('confirmButton');
    if (selectedDate && selectedTime) {
      confirmBtn.style.display = 'block';
      confirmBtn.textContent = '<%= t('hush.wellness.appointment.continue_button') %>';
    } else {
      confirmBtn.style.display = 'none';
    }
  }

  function confirmBooking() {
    if (!selectedDate || !selectedTime || selectedTreatments.length === 0) {
      alert('<%= t('hush.wellness.appointment.please_select_date_time') %>');
      return;
    }

    // Format date
    const dateStr = selectedDate.toLocaleDateString('<%= t('hush.wellness.date_format') %>', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    alert(`<%= t('hush.wellness.appointment.appointment_booked_for') %>: ${dateStr} um ${selectedTime}\n\n<%= t('hush.wellness.appointment.treatments_label') %>: ${selectedTreatments.map(t => treatments[t].name).join(', ')}`);

    // Here you would typically submit to your backend
    // For now, just show confirmation
  }

  // Form Validation
  function initializeFormValidation() {
    const fullName = document.getElementById('fullName');
    const phoneNumber = document.getElementById('phoneNumber');
    const email = document.getElementById('email');
    const consentCheckbox = document.getElementById('consentCheckbox');

    if (fullName) {
      fullName.addEventListener('blur', () => validateField('fullName', fullName.value));
      fullName.addEventListener('input', () => clearFieldError('fullName'));
    }

    if (phoneNumber) {
      phoneNumber.addEventListener('blur', () => validateField('phoneNumber', phoneNumber.value));
      phoneNumber.addEventListener('input', () => clearFieldError('phoneNumber'));
    }

    if (email) {
      email.addEventListener('blur', () => {
        if (email.value.trim()) {
          validateField('email', email.value);
        } else {
          clearFieldError('email');
        }
      });
      email.addEventListener('input', () => clearFieldError('email'));
    }

    if (consentCheckbox) {
      consentCheckbox.addEventListener('change', () => clearFieldError('consent'));
    }
  }

  function validateField(fieldName, value) {
    const trimmedValue = value.trim();
    let isValid = true;
    let errorMessage = '';

    switch (fieldName) {
      case 'fullName':
        if (!trimmedValue) {
          isValid = false;
          errorMessage = '<%= t('hush.wellness.appointment.validation.full_name_required') %>';
        } else {
          // Split name into first and last name
          const nameParts = trimmedValue.trim().split(/\s+/).filter(part => part.length > 0);
          if (nameParts.length < 2) {
            isValid = false;
            errorMessage = '<%= t('hush.wellness.appointment.validation.full_name_invalid') %>';
          } else {
            const firstName = nameParts[0];
            const lastName = nameParts.slice(1).join(' ');
            if (firstName.length < 2 || lastName.length < 2) {
              isValid = false;
              errorMessage = '<%= t('hush.wellness.appointment.validation.full_name_invalid') %>';
            } else if (isFakeValue(firstName) || isFakeValue(lastName)) {
              isValid = false;
              errorMessage = '<%= t('hush.wellness.appointment.validation.fake_value') %>';
            }
          }
        }
        break;

      case 'phoneNumber':
        if (!trimmedValue) {
          isValid = false;
          errorMessage = '<%= t('hush.wellness.appointment.validation.phone_required') %>';
        } else if (!isValidPhone(trimmedValue)) {
          isValid = false;
          errorMessage = '<%= t('hush.wellness.appointment.validation.phone_invalid') %>';
        }
        break;

      case 'email':
        if (trimmedValue && !isValidEmail(trimmedValue)) {
          isValid = false;
          errorMessage = '<%= t('hush.wellness.appointment.validation.email_invalid') %>';
        }
        break;

      case 'consent':
        const checkbox = document.getElementById('consentCheckbox');
        if (!checkbox || !checkbox.checked) {
          isValid = false;
          errorMessage = '<%= t('hush.wellness.appointment.validation.consent_required') %>';
        }
        break;
    }

    if (isValid) {
      clearFieldError(fieldName);
    } else {
      showFieldError(fieldName, errorMessage);
    }

    return isValid;
  }

  function validateForm() {
    const fullName = document.getElementById('fullName');
    const phoneNumber = document.getElementById('phoneNumber');
    const email = document.getElementById('email');
    const consentCheckbox = document.getElementById('consentCheckbox');

    let isValid = true;
    const errors = [];

    // Validate all fields
    if (!validateField('fullName', fullName.value)) {
      isValid = false;
      errors.push('<%= t('hush.wellness.appointment.validation.full_name_required') %>');
    }

    if (!validateField('phoneNumber', phoneNumber.value)) {
      isValid = false;
      errors.push('<%= t('hush.wellness.appointment.validation.phone_required') %>');
    }

    if (email.value.trim() && !validateField('email', email.value)) {
      isValid = false;
      errors.push('<%= t('hush.wellness.appointment.validation.email_invalid') %>');
    }

    if (!validateField('consent', '')) {
      isValid = false;
      errors.push('<%= t('hush.wellness.appointment.validation.consent_required') %>');
    }

    // Show errors under submit button
    const submitErrors = document.getElementById('submitErrors');
    if (errors.length > 0) {
      submitErrors.innerHTML = errors.map(err => `<div class="error-item">${err}</div>`).join('');
      submitErrors.classList.add('show');
    } else {
      submitErrors.classList.remove('show');
    }

    return isValid;
  }

  function showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorDiv = document.getElementById(fieldId + 'Error');

    if (field) {
      field.classList.add('field-error');
    }

    if (errorDiv) {
      errorDiv.textContent = message;
      errorDiv.classList.add('show');
    }
  }

  function clearFieldError(fieldId) {
    const field = document.getElementById(fieldId);
    const errorDiv = document.getElementById(fieldId + 'Error');

    if (field) {
      field.classList.remove('field-error');
    }

    if (errorDiv) {
      errorDiv.classList.remove('show');
      errorDiv.textContent = '';
    }
  }

  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function isValidPhone(phone) {
    // Phone must start with 0 or +XX (where XX is country code)
    const phoneRegex = /^(0|\+\d{1,3})/;
    return phoneRegex.test(phone) && phone.length >= 8;
  }

  function isFakeValue(value) {
    const fakeValues = ['test', '123', 'abc', 'xxx', 'asd', 'qwe', '1234', 'test123'];
    const lowerValue = value.toLowerCase();
    return fakeValues.some(fake => lowerValue.includes(fake)) && value.length <= 5;
  }

  // Submit Booking
  async function submitBooking(event) {
    event.preventDefault();

    // Validate form first
    if (!validateForm()) {
      return;
    }

    // Collect form data
    const fullName = document.getElementById('fullName').value.trim();
    // Split full name into first and last name
    const nameParts = fullName.split(/\s+/).filter(part => part.length > 0);
    const firstName = nameParts[0] || '';
    const lastName = nameParts.slice(1).join(' ') || '';

    const phoneNumber = document.getElementById('phoneNumber').value.trim();
    const email = document.getElementById('email').value.trim();
    const consentCheckbox = document.getElementById('consentCheckbox').checked;

    // Generate email if not provided
    const customerEmail = email || `${phoneNumber}@hush-haarentfernung.de`;

    // Calculate start_at and end_at (60 minutes duration)
    if (!selectedDate || !selectedTime) {
      alert('<%= t('hush.wellness.appointment.please_select_date_time') %>');
      return;
    }

    // Format date and time for ISO string
    const year = selectedDate.getFullYear();
    const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
    const day = String(selectedDate.getDate()).padStart(2, '0');
    const [hours, minutes] = selectedTime.split(':');

    // Create start_at datetime
    const startAt = new Date(`${year}-${month}-${day}T${hours}:${minutes}:00`);
    const startAtISO = startAt.toISOString();

    // Create end_at (60 minutes later)
    const endAt = new Date(startAt.getTime() + 60 * 60 * 1000);
    const endAtISO = endAt.toISOString();

    // Build treatments list for notes (get names from DOM)
    const treatmentsList = selectedTreatments.map(sku => {
      const row = document.querySelector(`.treatment-row[data-sku="${sku}"]`);
      if (row) {
        const nameElement = row.querySelector('.treatment-name');
        return nameElement ? nameElement.textContent.trim() : sku;
      }
      return sku;
    }).join(', ');
    const notes = `Treatments: ${treatmentsList}\n`;

    // Map currentGender to salutation
    // 'women' → 'female', 'men' → 'male'
    const salutation = currentGender === 'women' ? 'female' : 'male';

    // Prepare data to send
    const dataToSend = {
      customer: {
        first_name: firstName,
        last_name: lastName,
        email: customerEmail,
        mobile_number: phoneNumber,
        salutation: salutation
      },
      merchant_id: 2,
      start_at: startAtISO,
      end_at: endAtISO,
      notes: notes,
      article_skus: selectedTreatments // Send article SKUs
    };

    // Disable submit button
    const submitButton = document.getElementById('submitButton');
    submitButton.disabled = true;
    submitButton.textContent = '<%= t('hush.wellness.appointment.submit_appointment') %>...';

    try {
      const token = window.bookingToken ;
      const response = await fetch('/api/partner/issue_calendar_entries', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Token token=' + token
        },
        body: JSON.stringify(dataToSend)
      });

      const responseData = await response.json();

      if (response.ok) {
        // Success - redirect to thanks page
        const currentPath = window.location.pathname;
        let localePrefix = '';
        if (currentPath.includes('/en/')) {
          localePrefix = '/en';
        } else if (currentPath.includes('/de/')) {
          localePrefix = '/de';
        }
        // If no locale in path, use default (German) - no prefix needed
        window.location.href = `${localePrefix}/waxing_appointment/thanks`;
      } else {
        // Handle errors
        handleApiErrors(responseData);
        submitButton.disabled = false;
        submitButton.textContent = '<%= t('hush.wellness.appointment.submit_appointment') %>';
      }
    } catch (error) {
      console.error('Error submitting booking:', error);
      const submitErrors = document.getElementById('submitErrors');
      submitErrors.innerHTML = `<div class="error-item"><%= t('hush.wellness.appointment.validation.generic_error') %></div>`;
      submitErrors.classList.add('show');
      submitButton.disabled = false;
      submitButton.textContent = '<%= t('hush.wellness.appointment.submit_appointment') %>';
    }
  }

  function handleApiErrors(responseData) {
    const submitErrors = document.getElementById('submitErrors');
    let errorMessages = [];

    // Check for dry-schema errors (array format)
    if (responseData.errors && Array.isArray(responseData.errors)) {
      errorMessages = responseData.errors.map(err => {
        if (typeof err === 'string') {
          return err;
        } else if (err.path && err.text) {
          return `${err.path.join('.')}: ${err.text}`;
        }
        return JSON.stringify(err);
      });
    }
    // Check for ActiveRecord errors (object format)
    else if (responseData.errors && typeof responseData.errors === 'object') {
      Object.keys(responseData.errors).forEach(key => {
        const errors = Array.isArray(responseData.errors[key])
          ? responseData.errors[key]
          : [responseData.errors[key]];
        errors.forEach(err => {
          errorMessages.push(`${key}: ${err}`);
        });
      });
    }
    // General error
    else if (responseData.error || responseData.message) {
      errorMessages.push(responseData.error || responseData.message);
    }
    else {
      errorMessages.push('<%= t('hush.wellness.appointment.validation.generic_error') %>');
    }

    if (errorMessages.length > 0) {
      submitErrors.innerHTML = errorMessages.map(err => `<div class="error-item">${err}</div>`).join('');
      submitErrors.classList.add('show');

      // Scroll to errors
      setTimeout(() => {
        submitErrors.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }
  }
</script>

<%= render 'wellness_scripts' %>
